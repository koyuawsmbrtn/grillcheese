#!/bin/bash

# sprc - PNG to .spr converter for sprlib
# Usage: sprc input.png [output.spr]

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if Love2D is installed (needed for GCScript execution)
if ! command -v love >/dev/null 2>&1; then
    echo -e "${RED}Error: Love2D is not installed or not in PATH${NC}" >&2
    echo "Please install Love2D to use sprc" >&2
    exit 1
fi

# Check arguments
if [ $# -lt 1 ]; then
    echo -e "${BLUE}Usage:${NC} sprc input.png [output.spr]"
    echo -e "${BLUE}Convert PNG images to .spr format for sprlib${NC}"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  sprc sprite.png                    # Creates sprite.spr"
    echo "  sprc sprite.png custom.spr         # Creates custom.spr"
    echo "  sprc *.png                         # Convert all PNG files"
    exit 1
fi

# Function to convert a single file
convert_file() {
    local input_file="$1"
    local output_file="$2"
    
    # Check if input file exists
    if [ ! -f "$input_file" ]; then
        echo -e "${RED}Error: Input file not found: $input_file${NC}" >&2
        return 1
    fi
    
    # Check if input is a PNG file
    if [[ ! "$input_file" =~ \.png$ ]]; then
        echo -e "${RED}Error: Input file must be a PNG: $input_file${NC}" >&2
        return 1
    fi
    
    # Create temporary directory for conversion
    local temp_dir=$(mktemp -d -t sprc_converter_XXXXXX)
    local temp_main="$temp_dir/main.lua"
    
    # Create the GCScript runner
    cat > "$temp_main" << 'EOF'
-- GCScript runner for PNG to .spr conversion
local gcscript = require("gcscript")

function love.load()
    local args = love.arg.parseGameArguments(arg)
    
    if #args < 1 then
        print("Error: No input file specified")
        love.event.quit()
        return
    end
    
    local inputPath = args[1]
    local outputPath = args[2] or inputPath:gsub("%.png$", ".spr")
    
    -- Load and run the GCScript converter
    local success, result = pcall(function()
        local converter = gcscript.load("sprlib.png_converter")
        return converter.convert_png_to_spr(inputPath, outputPath)
    end)
    
    if not success then
        print("Error: " .. tostring(result))
        love.event.quit()
        return
    end
    
    if result then
        print("Conversion completed successfully!")
    else
        print("Conversion failed!")
    end
    
    love.event.quit()
end

function love.draw()
    -- Nothing to draw
end
EOF
    
    # Copy the sprlib folder to temp directory
    cp -r "$SCRIPT_DIR/sprlib" "$temp_dir/"
    
    # Copy the gcscript folder to temp directory
    cp -r "$SCRIPT_DIR/gcscript" "$temp_dir/"
    
    # Copy input file to temp directory
    cp "$input_file" "$temp_dir/"
    local temp_input=$(basename "$input_file")
    
    # Run the conversion
    echo -e "${BLUE}Converting:${NC} $input_file -> $output_file"
    if love "$temp_dir" "$temp_input" "$output_file" >/dev/null 2>&1; then
        # The GCScript converter writes to Love2D's save directory
        # We need to find and copy the created file
        local temp_dir_name=$(basename "$temp_dir")
        local love_save_dir="$HOME/.local/share/love/$temp_dir_name"
        
        if [ -f "$love_save_dir/$output_file" ]; then
            cp "$love_save_dir/$output_file" "$output_file"
            echo -e "${GREEN}✓ Successfully converted:${NC} $output_file"
        else
            echo -e "${YELLOW}Warning: .spr file created but not found in expected location${NC}"
            echo "Checked: $love_save_dir/$output_file"
            # Try to find the file in any Love2D save directory
            local found_file=$(find "$HOME/.local/share/love" -name "$output_file" -type f 2>/dev/null | head -1)
            if [ -n "$found_file" ]; then
                cp "$found_file" "$output_file"
                echo -e "${GREEN}✓ Found and copied file from:${NC} $found_file"
            else
                echo -e "${RED}✗ Conversion failed: Output file not found${NC}" >&2
                rm -rf "$temp_dir"
                return 1
            fi
        fi
        rm -rf "$temp_dir"
        return 0
    else
        echo -e "${RED}✗ Conversion failed:${NC} $input_file" >&2
        rm -rf "$temp_dir"
        return 1
    fi
}

# Process arguments
if [ $# -eq 1 ]; then
    # Single file - auto-generate output name
    input_file="$1"
    output_file="${input_file%.png}.spr"
    convert_file "$input_file" "$output_file"
else
    # Multiple files or explicit output
    if [ $# -eq 2 ]; then
        # Two arguments: input and output
        convert_file "$1" "$2"
    else
        # Multiple input files
        success_count=0
        total_count=0
        
        for input_file in "$@"; do
            if [[ "$input_file" =~ \.png$ ]]; then
                total_count=$((total_count + 1))
                output_file="${input_file%.png}.spr"
                if convert_file "$input_file" "$output_file"; then
                    success_count=$((success_count + 1))
                fi
            else
                echo -e "${YELLOW}Warning: Skipping non-PNG file: $input_file${NC}"
            fi
        done
        
        echo ""
        echo -e "${BLUE}Conversion complete:${NC} $success_count/$total_count files converted successfully"
        
        if [ $success_count -eq 0 ]; then
            exit 1
        fi
    fi
fi
